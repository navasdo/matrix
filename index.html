<!doctype html>
<html lang="en">
<head>
  <!-- Favicons -->
<link rel="icon" href="favicon.ico" sizes="any"><!-- classic desktop -->
<link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png">

<!-- Apple (iOS/iPadOS) home-screen icon -->
<link rel="apple-touch-icon" href="apple-touch-icon.png"><!-- 180Ã—180 is ideal -->

<!-- PWA / Android (Add to Home) -->
<link rel="manifest" href="site.webmanifest">
<meta name="theme-color" content="#111114">

<!-- Optional: nicer name when saved on iOS -->
<meta name="apple-mobile-web-app-title" content="NAPPS">
<meta name="application-name" content="NAPPS">

  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Eisenhower Matrix â€” Minimal, Fast, Accessible</title>
  <meta name="description" content="Prioritize tasks by urgency and importance. Create an account, log in, and manage your personal Eisenhower Matrix." />
  <meta name="color-scheme" content="light dark">
  <meta name="theme-color" content="#111114">
  <style>
    :root{
      --bg:#0b0b11; --panel:#14141c; --border: color-mix(in oklab, #e9edf1 12%, transparent);
      --fg:#e9edf1; --muted:#a1a8b3; --brand:#6aa3ff; --brand-ink:#0b4dd6;
      --chip:#1c1c27; --chip-hover:#232331; --shadow: 0 1px 0 rgba(0,0,0,.15), 0 8px 24px rgba(0,0,0,.25);
      --q1:#ef4444; --q2:#22c55e; --q3:#f59e0b; --q4:#9ca3af;
      color-scheme: light dark;
    }
    @media (prefers-color-scheme: light){
      :root{
        --bg:#ffffff; --panel:#f7f8fa; --fg:#101828; --muted:#475467; --brand:#1b72ff; --brand-ink:#0a3fd1;
        --chip:#eef2f7; --chip-hover:#e6ecf6; --border: color-mix(in oklab, #101828 14%, transparent);
        --shadow: 0 1px 0 rgba(0,0,0,.05), 0 8px 24px rgba(0,0,0,.08);
      }
    }
    html, body { height: 100%; }
    body {
      margin: 0; background: var(--bg); color: var(--fg);
      font: 400 16px/1.5 system-ui, -apple-system, "Segoe UI", Roboto, Ubuntu, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
      text-rendering: optimizeLegibility;
    }
    a { color: var(--brand); }
    .wrap { min-height: 100%; display: grid; grid-template-rows: auto 1fr auto }
    header, main, footer { padding-inline: clamp(1rem, 4vw, 3rem) }
    header { padding-block: 1rem; border-block-end: 1px solid var(--border) }
    main   { padding-block: 1.1rem } /* tighter on phones */
    footer { padding-block: 2rem; color: var(--muted) }
    :where(a,button,input,textarea,select):focus-visible{ outline: 2px solid var(--brand); outline-offset: 2px; }
    @media (prefers-reduced-motion: reduce){ *{ animation: none !important; transition: none !important; } }

    .card {
      max-width: 62rem; margin-inline: auto; background: var(--panel); border: 1px solid var(--border);
      border-radius: 16px; padding: clamp(.9rem, 2.5vw, 1.25rem); box-shadow: var(--shadow);
      container-type: inline-size;
    }
    .card.compact{ padding: clamp(.6rem, 2vw, .9rem); }

    .field { margin-block: .6rem }
    .field label{ display: inline-block; font-weight: 600; margin-block-end: .25rem }
    .hint { font-size: .9rem; color: var(--muted) }

    input[type="email"], input[type="password"], input[type="text"]{
      width: 100%; padding: .65rem .75rem; border-radius: 12px; border: 1px solid var(--border);
      background: color-mix(in oklab, var(--fg) 5%, transparent); color: var(--fg);
    }
    button {
      border: none; border-radius: 999px; padding: .7rem 1rem; font-weight: 600; cursor: pointer;
      background: linear-gradient(180deg, var(--brand), var(--brand-ink)); color: white;
      box-shadow: 0 1px 0 rgba(255,255,255,.06) inset, 0 6px 18px color-mix(in oklab, var(--brand) 40%, transparent);
    }
    button:disabled{ opacity: .6; cursor: not-allowed }
    .muted-btn{ background: none; color: var(--brand); border: 1px solid var(--border); box-shadow: none; padding: .6rem .9rem }

    /* Modal */
    .backdrop{
      position: fixed; inset: 0; display: none; align-items: center; justify-content: center;
      padding: 1rem; z-index: 1000; background: color-mix(in oklab, black 50%, transparent); backdrop-filter: blur(6px);
    }
    .backdrop.open{ display: flex; }
    .dialog{
      width: min(34rem, 92vw); background: var(--panel); border: 1px solid var(--border);
      border-radius: 16px; padding: clamp(1rem, 2.5vw, 1.5rem); box-shadow: var(--shadow);
    }
    .dialog header{ display:flex; align-items:center; justify-content:space-between; gap:.5rem; border:0; padding:0 }
    .close-x{ background:none; color:var(--muted); border:1px solid var(--border); border-radius:10px; padding:.35rem .55rem; }

    /* Matrix */
    .matrix-wrap { display: grid; gap: .8rem; }
    @container (min-width: 54rem){ .matrix-wrap { grid-template-columns: 1fr 1fr; grid-auto-rows: 1fr } }
    .quad {
      display: grid; grid-template-rows: auto auto 1fr; gap: .4rem;
      background: color-mix(in oklab, var(--fg) 6%, transparent); border: 1px solid var(--border);
      border-radius: 14px; padding: .8rem; min-height: 11rem; outline-offset: 2px; overflow: clip;
    }
    .quad header { display:flex; align-items:baseline; justify-content:space-between; gap:.5rem; padding:0; border:0 }
    .quad h2 { margin:0; font-size:1rem }
    .tags { display:flex; flex-wrap:wrap; gap:.5rem; align-content:start; padding-block-start:.25rem }

    .chip {
      display:inline-flex; align-items:center; gap:.45rem; padding:.4rem .6rem;
      background: var(--chip); border: 1px solid var(--border); border-radius: 999px;
      user-select:none; cursor:grab; touch-action:none;
    }
    .chip .kind{ font-size: .95rem; line-height: 1; }
    .chip:focus-visible{ outline-offset:3px }
    .chip:hover{ background: var(--chip-hover) }
    .chip.dragging{ opacity:.6; cursor:grabbing }
    .chip button.remove{ border:none; background:none; color:var(--muted); padding:0 .1rem; line-height:1; cursor:pointer }

    .quad[aria-dropeffect="move"]{ box-shadow: 0 0 0 2px color-mix(in oklab, var(--brand) 40%, transparent) inset }

    .keyline { color: var(--muted); font-size: .85rem }
    .hide { display: none !important }

    /* Quadrant colors */
    .quad[data-q="Q1"]{ background: color-mix(in oklab, var(--q1) 12%, transparent); border-color: color-mix(in oklab, var(--q1) 40%, var(--border)); }
    .quad[data-q="Q2"]{ background: color-mix(in oklab, var(--q2) 10%, transparent); border-color: color-mix(in oklab, var(--q2) 38%, var(--border)); }
    .quad[data-q="Q3"]{ background: color-mix(in oklab, var(--q3) 10%, transparent); border-color: color-mix(in oklab, var(--q3) 38%, var(--border)); }
    .quad[data-q="Q4"]{ background: color-mix(in oklab, var(--q4) 10%, transparent); border-color: color-mix(in oklab, var(--q4) 35%, var(--border)); }

    /* Tight spacing for small screens */
    #app.card{ padding: clamp(.6rem, 2vw, .9rem); }
    #app > header{ margin-block-end: .25rem; }
  </style>
</head>
<body>
  <div class="wrap">
    <header role="banner"></header>

    <main id="content" role="main">
      <!-- LOGIN -->
      <section id="auth" class="card" aria-labelledby="auth-title">
        <h1 id="auth-title">Sign in to your Matrix</h1>
        <p class="keyline">
          Tip while adding: <kbd>Enter</kbd> = <strong>Personal</strong>, <kbd>Tab</kbd> = <strong>Work</strong>.
          Drag chips between quadrants to reorganize.
        </p>
        <form id="login-form" autocomplete="on" novalidate>
          <div class="field">
            <label for="login-email">Email</label>
            <input id="login-email" name="email" type="email" inputmode="email" required autocomplete="email" />
          </div>
          <div class="field">
            <label for="login-pass">Password</label>
            <input id="login-pass" name="password" type="password" required autocomplete="current-password" minlength="8" />
          </div>
          <div class="field" style="display:flex; gap:.5rem; flex-wrap:wrap">
            <button id="login-btn" type="submit">Sign in</button>
            <button id="to-signup" type="button" class="muted-btn" aria-haspopup="dialog" aria-controls="signup-backdrop">Create an account</button>
          </div>
          <p class="hint" id="auth-hint" role="status" aria-live="polite"></p>
        </form>
      </section>

      <!-- SIGNUP MODAL -->
      <div id="signup-backdrop" class="backdrop" role="presentation" aria-hidden="true">
        <div class="dialog" role="dialog" aria-modal="true" aria-labelledby="signup-title">
          <header>
            <h2 id="signup-title" style="margin:0">Create account</h2>
            <button class="close-x" type="button" id="close-signup" aria-label="Close">âœ•</button>
          </header>
          <form id="signup-form" autocomplete="on" novalidate>
            <div class="field">
              <label for="signup-email">Email</label>
              <input id="signup-email" type="email" required autocomplete="email" />
            </div>
            <div class="field">
              <label for="signup-pass">Password</label>
              <input id="signup-pass" type="password" required autocomplete="new-password" minlength="8" />
              <p class="hint">Use 8+ characters. Your matrix is tied to this email.</p>
            </div>
            <div class="field" style="display:flex; gap:.5rem; flex-wrap:wrap">
              <button id="signup-btn" type="submit">Create account</button>
              <button id="cancel-signup" type="button" class="muted-btn">Cancel</button>
            </div>
            <p class="hint" id="signup-hint" role="status" aria-live="polite"></p>
          </form>
        </div>
      </div>

      <!-- APP -->
      <section id="app" class="card compact hide" aria-labelledby="app-title">
        <header style="display:flex;justify-content:space-between;align-items:center;gap:.75rem; border:0; padding:0">
          <div>
            <h1 id="app-title" style="margin:0">Your Eisenhower Matrix</h1>
            <p id="whoami" class="keyline" role="status" aria-live="polite"></p>
            <p class="keyline"> &#128161; <strong>Tip:</strong> Drag chips between quadrants to reorganize.<br>  &#128395; <a href="/scribe.html"> Scribe Notes || Placeholder || Placeholder </p>
          </div>
          <div><button id="logout-btn" class="muted-btn" type="button">Log out</button></div>
        </header>

        <div class="matrix-wrap" id="matrix" role="grid" aria-describedby="matrix-desc">
          <section class="quad" data-q="Q1" role="row" aria-labelledby="q1h">
            <header><h2 id="q1h">Q1 â€” Urgent & Important</h2><span class="keyline">Do now</span></header>
            <div class="field"><label class="hide" for="in-q1">Add item to Q1</label><input id="in-q1" data-q="Q1" type="text" placeholder="Add taskâ€¦ Enter=Personal Â· Tab=Work" /></div>
            <div class="tags" role="list" aria-label="Q1 items"></div>
          </section>

          <section class="quad" data-q="Q2" role="row" aria-labelledby="q2h">
            <header><h2 id="q2h">Q2 â€” Not Urgent & Important</h2><span class="keyline">Schedule</span></header>
            <div class="field"><label class="hide" for="in-q2">Add item to Q2</label><input id="in-q2" data-q="Q2" type="text" placeholder="Add taskâ€¦ Enter=Personal Â· Tab=Work" /></div>
            <div class="tags" role="list" aria-label="Q2 items"></div>
          </section>

          <section class="quad" data-q="Q3" role="row" aria-labelledby="q3h">
            <header><h2 id="q3h">Q3 â€” Urgent & Not Important</h2><span class="keyline">Delegate</span></header>
            <div class="field"><label class="hide" for="in-q3">Add item to Q3</label><input id="in-q3" data-q="Q3" type="text" placeholder="Add taskâ€¦ Enter=Personal Â· Tab=Work" /></div>
            <div class="tags" role="list" aria-label="Q3 items"></div>
          </section>

          <section class="quad" data-q="Q4" role="row" aria-labelledby="q4h">
            <header><h2 id="q4h">Q4 â€” Not Urgent & Not Important</h2><span class="keyline">Eliminate</span></header>
            <div class="field"><label class="hide" for="in-q4">Add item to Q4</label><input id="in-q4" data-q="Q4" type="text" placeholder="Add taskâ€¦ Enter=Personal Â· Tab=Work" /></div>
            <div class="tags" role="list" aria-label="Q4 items"></div>
          </section>
        </div>
      </section>
    </main>

    <footer role="contentinfo"><small>Â© 2025 NAPPS</small></footer>
  </div>

  <script type="module">
    // ========= CONFIG =========
    // Your deployed Apps Script Web App URL:
    const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbxiS3Y1TwRklu8e4pdHAambKaocSUwcYShiW11GY6hlPknB49QbefgUoy6rsb9DC_M/exec';

    // ========= UTILITIES =========
    const $ = (sel, el=document) => el.querySelector(sel);
    const $$ = (sel, el=document) => Array.from(el.querySelectorAll(sel));
    const byId = id => document.getElementById(id);
    const quads = ['Q1','Q2','Q3','Q4'];

    // JSONP transport (no CORS). Payload is base64url-encoded to keep logs tidy.
    function b64uEncode(str){ return btoa(unescape(encodeURIComponent(str))).replaceAll('+','-').replaceAll('/','_').replace(/=+$/,''); }
    let cbSeq = 0;
    function jsonp(action, payload={}){
      return new Promise((resolve, reject) => {
        const callbackName = `__jsonp_cb_${Date.now()}_${cbSeq++}`;
        const onTimeout = setTimeout(() => { cleanup(); reject(new Error('Network timeout')); }, 20000);
        function cleanup(){
          clearTimeout(onTimeout);
          delete window[callbackName];
          script.remove();
        }
        window[callbackName] = (data) => { cleanup(); if (data && data.error) reject(new Error(data.error)); else resolve(data); };
        const d = b64uEncode(JSON.stringify({ action, ...payload }));
        const script = document.createElement('script');
        script.src = `${WEB_APP_URL}?a=${encodeURIComponent(action)}&d=${encodeURIComponent(d)}&callback=${encodeURIComponent(callbackName)}`;
        script.onerror = () => { cleanup(); reject(new Error('Network error')); };
        document.head.appendChild(script);
      });
    }

    const svc = {
      signup: (email, pass)                   => jsonp('signup', { email, password: pass }),
      login:  (email, pass)                   => jsonp('login',  { email, password: pass }),
      me:     (token)                         => jsonp('me',     { token }),
      list:   (token)                         => jsonp('list',   { token }),
      add:    (token, text, quadrant, kind)   => jsonp('add',    { token, text, quadrant, kind }),
      move:   (token, id, quadrant, order)    => jsonp('move',   { token, id, quadrant, order }),
      remove: (token, id)                     => jsonp('delete', { token, id }),
      logout: (token)                         => jsonp('logout', { token })
    };

    // ========= STATE & VIEWS =========
    const state = { token:null, user:null, items:[] };
    const authView = byId('auth'), appView = byId('app');
    const authHint = byId('auth-hint'), signupHint = byId('signup-hint');
    const whoami = byId('whoami');

    // Signup modal controls
    const backdrop = byId('signup-backdrop');
    const dialog = backdrop?.querySelector('.dialog');
    const openSignup = () => { backdrop.classList.add('open'); backdrop.removeAttribute('aria-hidden'); authView.setAttribute('aria-hidden','true'); document.body.style.overflow='hidden'; byId('signup-email').focus(); };
    const closeSignup = () => { backdrop.classList.remove('open'); backdrop.setAttribute('aria-hidden','true'); authView.removeAttribute('aria-hidden'); document.body.style.overflow=''; byId('to-signup').focus(); };
    byId('to-signup').addEventListener('click', openSignup);
    byId('close-signup').addEventListener('click', closeSignup);
    byId('cancel-signup').addEventListener('click', closeSignup);
    backdrop.addEventListener('click', (e) => { if (e.target === backdrop) closeSignup(); });
    document.addEventListener('keydown', (e) => { if (backdrop.classList.contains('open') && e.key === 'Escape') closeSignup(); });
    backdrop.addEventListener('keydown', (e) => {
      if (!backdrop.classList.contains('open') || e.key !== 'Tab') return;
      const focusables = dialog.querySelectorAll('button,[href],input,select,textarea,[tabindex]:not([tabindex="-1"])');
      const first = focusables[0], last = focusables[focusables.length - 1];
      if (e.shiftKey && document.activeElement === first){ e.preventDefault(); last.focus(); }
      else if (!e.shiftKey && document.activeElement === last){ e.preventDefault(); first.focus(); }
    });

    // Auth
    byId('signup-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const email = byId('signup-email').value.trim();
      const pass  = byId('signup-pass').value;
      signupHint.textContent = '';
      try{
        const { token, user } = await svc.signup(email, pass);
        state.token = token; state.user = user;
        localStorage.setItem('matrix_token', token);
        closeSignup();
        await boot();
      }catch(err){ signupHint.textContent = String(err.message || err); }
    });

    byId('login-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const email = byId('login-email').value.trim();
      const pass  = byId('login-pass').value;
      authHint.textContent = '';
      try{
        const { token, user } = await svc.login(email, pass);
        state.token = token; state.user = user;
        localStorage.setItem('matrix_token', token);
        await boot();
      }catch(err){ authHint.textContent = String(err.message || err); }
    });

    byId('logout-btn').addEventListener('click', async () => {
      try{ await svc.logout(state.token); }catch{}
      localStorage.removeItem('matrix_token');
      state.token = null; state.user = null; state.items = [];
      render();
    });

    // Matrix
    function render(){
      if (state.token && state.user){
        authView.classList.add('hide'); appView.classList.remove('hide');
        whoami.textContent = `Signed in as ${state.user.email}`;
        for (const q of quads){
          const panel = document.querySelector(`.quad[data-q="${q}"]`);
          const list = panel.querySelector('.tags');
          list.innerHTML = '';
          const items = state.items.filter(it => it.quadrant === q).sort((a,b)=>a.order-b.order);
          for (const it of items) list.appendChild(chip(it));
        }
        enableDnD();
      }else{
        appView.classList.add('hide'); authView.classList.remove('hide');
      }
    }

    function chip(item){
      const el = document.createElement('div');
      el.className = 'chip';
      el.setAttribute('role','listitem');
      el.setAttribute('tabindex','0');
      el.setAttribute('draggable','true');
      el.dataset.id = item.id;
      el.dataset.q = item.quadrant;

      const kind = document.createElement('span');
      kind.className = 'kind';
      kind.textContent = item.kind === 'work' ? 'ðŸ’¼' : 'ðŸ ';
      kind.setAttribute('aria-label', item.kind === 'work' ? 'Work' : 'Personal');
      el.appendChild(kind);

      el.append(item.text);

      const rm = document.createElement('button');
      rm.className = 'remove'; rm.type = 'button'; rm.setAttribute('aria-label', `Remove â€œ${item.text}â€`);
      rm.textContent = 'Ã—';
      rm.addEventListener('click', async (e) => {
        e.stopPropagation();
        try{
          await svc.remove(state.token, item.id);
          state.items = state.items.filter(x=>x.id!==item.id);
          render();
        }catch(err){ alert(err.message || err); }
      });
      el.appendChild(rm);

      el.addEventListener('keydown', async (e) => {
        if ((e.ctrlKey || e.metaKey) && ['ArrowUp','ArrowRight','ArrowDown','ArrowLeft'].includes(e.key)){
          e.preventDefault();
          const idx = quads.indexOf(item.quadrant);
          const dir = (e.key === 'ArrowRight' || e.key === 'ArrowDown') ? 1 : -1;
          const next = quads[(idx + dir + 4) % 4];
          await moveItem(item.id, next);
        }
      });

      el.addEventListener('dragstart', () => el.classList.add('dragging'));
      el.addEventListener('dragend',   () => el.classList.remove('dragging'));
      return el;
    }

    // Create chip: Enter => personal, Tab => work
    $$('.quad input[type="text"]').forEach(inp => {
      inp.addEventListener('keydown', async (e) => {
        const key = e.key;
        const ok = (key === 'Enter' || key === 'Tab') && inp.value.trim();
        if (!ok) return;
        e.preventDefault();
        const text = inp.value.trim();
        const kind = key === 'Tab' ? 'work' : 'personal';
        try{
          const { item } = await svc.add(state.token, text, inp.dataset.q, kind);
          state.items.push(item);
          inp.value = '';
          render();
          inp.focus();
        }catch(err){ alert(err.message || err); }
      });
    });

    function enableDnD(){
      $$('.quad').forEach(quad => {
        quad.addEventListener('dragover', (e) => { e.preventDefault(); quad.setAttribute('aria-dropeffect','move'); });
        quad.addEventListener('dragleave', () => { quad.removeAttribute('aria-dropeffect'); });
        quad.addEventListener('drop', async (e) => {
          e.preventDefault();
          quad.removeAttribute('aria-dropeffect');
          const dragging = document.querySelector('.chip.dragging');
          if (!dragging) return;
          const id = dragging.dataset.id;
          const targetQ = quad.dataset.q;
          await moveItem(id, targetQ);
        });
      });
    }

    async function moveItem(id, newQ){
      try{
        const targetItems = state.items.filter(x=>x.quadrant===newQ).sort((a,b)=>a.order-b.order);
        const newOrder = targetItems.length ? targetItems[targetItems.length-1].order + 1 : 0;
        await svc.move(state.token, id, newQ, newOrder);
        const it = state.items.find(x=>x.id===id);
        if (it){ it.quadrant = newQ; it.order = newOrder; }
        render();
      }catch(err){ alert(err.message || err); }
    }

    // Boot
    async function boot(){
      state.token = state.token || localStorage.getItem('matrix_token');
      if (!state.token){ render(); return; }
      try{
        const user = await svc.me(state.token);
        state.user = user;
        const { items } = await svc.list(state.token);
        state.items = items;
      }catch{
        localStorage.removeItem('matrix_token');
        state.token = null; state.user = null; state.items = [];
      }
      render();
    }
    boot();
  </script>
</body>
</html>
